
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Normalizing the State Shape Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="javascript-redux-wrapping-dispatch-to-log-actions.html" />
    
    
    <link rel="prev" href="javascript-redux-colocating-selectors-with-reducers.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="javascript-redux-simplifying-the-arrow-functions.html">
            
                <a href="javascript-redux-simplifying-the-arrow-functions.html">
            
                    
                    Simplifying the Arrow Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="javascript-redux-supplying-the-initial-state.html">
            
                <a href="javascript-redux-supplying-the-initial-state.html">
            
                    
                    Supplying the Initial State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="javascript-redux-persisting-the-state-to-the-local-storage.html">
            
                <a href="javascript-redux-persisting-the-state-to-the-local-storage.html">
            
                    
                    Persisting the State to the Local Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="javascript-redux-refactoring-the-entry-point.html">
            
                <a href="javascript-redux-refactoring-the-entry-point.html">
            
                    
                    Refactoring the Entry Point
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="javascript-redux-adding-react-router-to-the-project.html">
            
                <a href="javascript-redux-adding-react-router-to-the-project.html">
            
                    
                    Adding React Router to the Project
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="javascript-redux-navigating-with-react-router-link.html">
            
                <a href="javascript-redux-navigating-with-react-router-link.html">
            
                    
                    Navigating with React Router 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="javascript-redux-filtering-redux-state-with-react-router-params.html">
            
                <a href="javascript-redux-filtering-redux-state-with-react-router-params.html">
            
                    
                    Filtering Redux State with React Router Params
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="javascript-redux-using-withrouter-to-inject-the-params-into-connected-components.html">
            
                <a href="javascript-redux-using-withrouter-to-inject-the-params-into-connected-components.html">
            
                    
                    Using withRouter() to Inject the Params into Connected Components
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="javascript-redux-using-mapdispatchtoprops-shorthand-notation.html">
            
                <a href="javascript-redux-using-mapdispatchtoprops-shorthand-notation.html">
            
                    
                    Using mapDispatchToProps() Shorthand Notation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="javascript-redux-colocating-selectors-with-reducers.html">
            
                <a href="javascript-redux-colocating-selectors-with-reducers.html">
            
                    
                    Colocating Selectors with Reducers
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.12" data-path="javascript-redux-normalizing-the-state-shape.html">
            
                <a href="javascript-redux-normalizing-the-state-shape.html">
            
                    
                    Normalizing the State Shape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="javascript-redux-wrapping-dispatch-to-log-actions.html">
            
                <a href="javascript-redux-wrapping-dispatch-to-log-actions.html">
            
                    
                    Wrapping dispatch() to Log Actions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="javascript-redux-adding-a-fake-backend-to-the-project.html">
            
                <a href="javascript-redux-adding-a-fake-backend-to-the-project.html">
            
                    
                    Adding a Fake Backend to the Project
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Normalizing the State Shape</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p>We currently represent the todos in the state tree as an array of todo objects. However, in the real app, we probably have more than a single array and then todos with the same IDs in different arrays might get out of sync.</p><p>This is why I wanted to <strong>treat my state as a database</strong>, and I&apos;m going to keep my todos in an object indexed by the IDs of the todos. I&apos;ve renamed the reducer to <code>byId</code> and rather than add a new item at the end or map over every item, now it&apos;s going to change the value in the lookup table.</p><p>Both <code>TOGGLE_TODO</code> and <code>ADD_TODO</code> object is now going to be the same. I want to return a new <strong>lookup table</strong> where the value unto the ID in the action is going to be the result of calling the reducer on the previous value under reducer ID and the action.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> byId = (state = {}, action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;TOGGLE_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        [action.id]: todo(state[action.id], action),
    };
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};</code></pre>
<p>This is to reduce a composition but with an object instead of an array. I&apos;m also using the <strong>object spread operator</strong> here. It is <strong>not</strong> a part of ES6 so you need to enable <code>transform-object-rest-spread</code> in babel reducer file, and you need to install the <code>babel-plugin-transform-object-rest-spread</code> for this to work.</p><p><strong>.babelrc</strong></p><pre><code>{
  &quot;presets&quot;: [&quot;es2015&quot;, &quot;react&quot;],
  &quot;plugins&quot;: [&quot;transform-object-rest-operator&quot;]
}</code></pre>
<p>Anytime the <code>byId</code> reducer receives an action, it&apos;s going to return the copy of its mapping between the IDs and the actual todos with updated todo for the current action. I will let another reducer that keeps track of all the added IDs.</p><p>We keep the todos themselves in the <code>byId</code> map now, so the state of this reducer is an array of IDs rather than array of todos. I <code>switch</code> on the action type and the only action I care about is <code>ADD_TODO</code> because if a new todo is added, I want to return a new array of IDs with that ID as the last item.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> allIds = (state = [], action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> [...state, action.id];
  }
};</code></pre>
<p>For any other actions, I just need to return the current state, that is, the current array of IDs. Finally, I still need to export the single reducer from the todos file, so I&apos;m going to use <code>combinedReducers</code> again to combine the <code>byId</code> and the <code>allIds</code> reducers.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> allIds = (state = [], action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> [...state, action.id];
    <span class="hljs-keyword">default</span>: 
      <span class="hljs-keyword">return</span> state;
  }
};

<span class="hljs-keyword">const</span> todos = combineReducers({
  byId,
  allIds,
});</code></pre>
<p>You can use <code>combinedReducers</code> as many times as you like. You don&apos;t have to only use it on the top-level reducer. In fact, it&apos;s very common that as your app grows, you&apos;ll use combine reducers in several places.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">import</span> { combineReducers } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux&apos;</span>;</code></pre>
<p>Now that we have changed the state shape in reducers, we also need to update the selectors that rely on it. The <code>state</code> object then <code>getVisibleTodos</code> is now going to contain <code>byId</code> and <code>allIds</code> fields, because it corresponds to the C of the combined reducer.</p><p>Since I don&apos;t have the array of todos anymore, I will write the selector that is going to calculate it for me. I won&apos;t export it because I only plan to use it in the current file and it takes the current state and returns all the todos by mapping AllIDs to the state ByID lookup table.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> getAllTodos = (state) =&gt; 
  state.allIds.map(id =&gt; state.byId[id]);</code></pre>
<p>I will use this name selector inside my <code>getVisibleTodos</code> selector to obtain an array of todos that I can filter. <code>allTodos</code> is an array of todos just like the components I expect so I can return it from the selector and not worry about change in my component code.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getVisibleTodos = (state, filter) =&gt; {
  <span class="hljs-keyword">const</span> allTodos = getAllTodos(state);
  <span class="hljs-keyword">switch</span> (filter) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;all&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;completed&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos.filter(t =&gt; t.completed);
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;active&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos.filter(t =&gt; !t.completed);
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown filter: <span class="hljs-subst">${filter}</span>.`</span>);
  }
};</code></pre>
<p>My todos file has grown quite a bit so it&apos;s a good time to extract the <code>todo</code> reducer that manages just a single todo into a separate file of its own. I created a file called todo in the same folder and I will paste my implementation right there so that I can import it from the todos file.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">import</span> todo <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./todo&apos;</span>;</code></pre>
<p>Let&apos;s recap how we change those state structures to be normalized and more like a database. I just extracted the <code>todo</code> reducer into a separate file but it hasn&apos;t changed in the state.</p><p><strong>/reducers/todo.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> todo = (state, action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> {
        id: action.id,
        text: action.text,
        completed: <span class="hljs-literal">false</span>,
      };
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;TOGGLE_TODO&apos;</span>:
      <span class="hljs-keyword">if</span> (state.id !== action.id) {
        <span class="hljs-keyword">return</span> state;
      }
      <span class="hljs-keyword">return</span> {
        ...state,
        completed: !state.completed,
      };
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> todo;</code></pre>
<p>It&apos;s still a reducer that handles updates to a single todo item. I&apos;m using this reducer inside the new reducer I wrote today, which is called <code>byId</code> and its state shape is an object. It reads the ID of the todo to update from the action and it calls the <code>todo</code> reducer with the previous state of this ID and the action.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> byId = (state = {}, action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;TOGGLE_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        [action.id]: todo(state[action.id], action),
    };
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};</code></pre>
<p>For the <code>ADD_TODO</code> action, the corresponding todo will not exist in the lookup table yet. We&apos;re calling the <code>todo</code> reducer with <code>undefined</code> as the first argument. The <code>todo</code> reducer would then return a new todo object when handling <code>ADD_TODO</code> so this object will get assigned under the <code>action.id</code> key inside the next version of the lookup table.</p><p>Notice how we&apos;re mixing the <strong>objects spread operator</strong> with the <strong>computed property syntax</strong>, which lets us specify a value at a dynamic key inside <code>action.id</code>. Also, remember that the objects spread operator is experimental and you need a special babel plugin to enable it.</p><p>I also wrote a second reducer called <code>addIds</code> that manages just the array of IDs of the todos. Every time a todo is added, it returns a new array with this ID of the new todo at the very end.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> allIds = (state = [], action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;ADD_TODO&apos;</span>:
      <span class="hljs-keyword">return</span> [...state, action.id];
    <span class="hljs-keyword">default</span>: 
      <span class="hljs-keyword">return</span> state;
  }
};</code></pre>
<p>It uses the <strong>array-spread operator</strong>, which is part of ES6, to produce a new array with the <code>allIds</code> followed by the new ID. The two reducers now handle the same action. This is fine and very common in the Redux apps.</p><p>I&apos;m combining the two reducers I wrote into a single reducer by calling <code>combineReducers</code> provided by Redux. You may use <code>combineReducers</code> at multiple levels in your reducer hierarchy.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">const</span> todos = combineReducers({
  byId,
  allIds,
});

Since the state shape changed, I needed to update the selectors that depend on it. I wrote the private selector called <span class="hljs-string">`getAllTodos`</span> that just assembles all the todos objects <span class="hljs-keyword">from</span> the state by mapping the IDs to the lookup table.

**todos.js**
<span class="hljs-string">``</span><span class="hljs-string">`javascript
const getAllTodos = (state) =&gt; 
  state.allIds.map(id =&gt; state.byId[id]);</span></code></pre>
<p>For every ID, we get the todo from <code>state.byId</code>. I&apos;m returning the array of todos with exactly the same shape as the state inside <code>getVisibleTodos</code> used to be before this change.</p><p><strong>todos.js</strong></p><pre><code class="lang-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getVisibleTodos = (state, filter) =&gt; {
  <span class="hljs-keyword">const</span> allTodos = getAllTodos(state);
  <span class="hljs-keyword">switch</span> (filter) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;all&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;completed&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos.filter(t =&gt; t.completed);
    <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;active&apos;</span>:
      <span class="hljs-keyword">return</span> allTodos.filter(t =&gt; !t.completed);
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Unknown filter: <span class="hljs-subst">${filter}</span>.`</span>);
  }
};</code></pre>
<p>I can get <code>allTodos</code> and now I can use <code>allTodos</code> for filtering and I can return it to the new ID that doesn&apos;t need to be changed, because all the state shape knowledge is encapsulated in the selector.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="javascript-redux-colocating-selectors-with-reducers.html" class="navigation navigation-prev " aria-label="Previous page: Colocating Selectors with Reducers">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="javascript-redux-wrapping-dispatch-to-log-actions.html" class="navigation navigation-next " aria-label="Next page: Wrapping dispatch() to Log Actions">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Normalizing the State Shape","level":"1.12","depth":1,"next":{"title":"Wrapping dispatch() to Log Actions","level":"1.13","depth":1,"path":"lessons/javascript-redux-wrapping-dispatch-to-log-actions.md","ref":"./lessons/javascript-redux-wrapping-dispatch-to-log-actions.md","articles":[]},"previous":{"title":"Colocating Selectors with Reducers","level":"1.11","depth":1,"path":"lessons/javascript-redux-colocating-selectors-with-reducers.md","ref":"./lessons/javascript-redux-colocating-selectors-with-reducers.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lessons/javascript-redux-normalizing-the-state-shape.md","mtime":"2016-08-23T19:38:19.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-08-24T21:28:02.324Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

